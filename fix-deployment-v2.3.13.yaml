apiVersion: apps/v1
kind: Deployment
metadata:
  name: arc-gha-rs-controller-actions-runner-controller
  namespace: arc-systems
spec:
  template:
    spec:
      nodeSelector:
        kubernetes.io/hostname: tenki-staging-runner-2
      containers:
      - name: manager
        image: us-west1-docker.pkg.dev/tenki-cloud/tenki-runners-prod/arc-aakash-no-run:v2.3.13-firecracker
        env:
        - name: GITHUB_APP_ID
          valueFrom:
            secretKeyRef:
              name: controller-manager
              key: github_app_id
        - name: GITHUB_APP_INSTALLATION_ID
          valueFrom:
            secretKeyRef:
              name: controller-manager
              key: github_app_installation_id
        - name: GITHUB_APP_PRIVATE_KEY
          valueFrom:
            secretKeyRef:
              name: controller-manager
              key: github_app_private_key
        - name: ENABLE_FIRECRACKER
          value: "true"
        - name: ARC_CONTROLLER_URL
          value: "http://tenki-staging-runner-2:30080"
        - name: FIRECRACKER_MAX_CONCURRENT_VMS
          value: "3"
        - name: FIRECRACKER_MIN_FREE_DISK_GB
          value: "30"
        securityContext:
          privileged: true
          capabilities:
            add:
            - NET_ADMIN
            - SYS_ADMIN
            - SYS_RESOURCE
        volumeMounts:
        - name: secret
          mountPath: /etc/arc
          readOnly: true
        - name: cert
          mountPath: /tmp/k8s-webhook-server/serving-certs
          readOnly: true
        - name: tmp
          mountPath: /tmp
        - name: tmp-firecracker
          mountPath: /tmp/firecracker
        - name: firecracker-assets
          mountPath: /opt/firecracker
        - name: firecracker-runtime
          mountPath: /var/lib/firecracker
        - name: firecracker-logs
          mountPath: /var/log/firecracker
        - name: dev-net-tun
          mountPath: /dev/net/tun
        - name: proc
          mountPath: /proc
        - name: sys
          mountPath: /sys
      volumes:
      - name: secret
        secret:
          secretName: controller-manager
      - name: cert
        secret:
          secretName: arc-gha-rs-controller-actions-runner-controller-serving-cert
      - name: tmp
        emptyDir: {}
      - name: tmp-firecracker
        emptyDir: {}
      - name: firecracker-assets
        hostPath:
          path: /opt/firecracker
          type: Directory
      - name: firecracker-runtime
        hostPath:
          path: /var/lib/firecracker
          type: DirectoryOrCreate
      - name: firecracker-logs
        hostPath:
          path: /var/log/firecracker
          type: DirectoryOrCreate
      - name: dev-net-tun
        hostPath:
          path: /dev/net/tun
          type: CharDevice
      - name: proc
        hostPath:
          path: /proc
          type: Directory
      - name: sys
        hostPath:
          path: /sys
          type: Directory 